<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Biometric Network</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- FontAwesome & MRZ Scanner -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-mrz-scanner@3.0.0/dist/mrz-scanner.bundle.js"></script>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #000000;
      display: flex;
      flex-direction: column;
    }

    .container {
      text-align: center;
      width: 100%;
      max-width: 400px;
      padding: 20px;
      margin: auto;
    }

    .logo-img {
      width: 50%;
      object-fit: contain;
    }

    .login-title {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0 5px;
    }

    .subtitle {
      font-size: 16px;
      color: #333;
      margin-bottom: 30px;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      margin: 10px auto;
      border: none;
      border-radius: 5px;
      width: 100%;
      max-width: 340px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn span {
      display: flex;
      align-items: center;
    }

    .btn span:first-child i {
      margin-right: 10px;
    }

    .btn-orange {
      background-color: #ff9800;
      color: #fff;
    }

    .btn-orange:hover {
      background-color: #e68900;
    }

    .btn-blue {
      background-color: #3c8dbc;
      color: #fff;
    }

    .btn-blue:hover {
      background-color: #327fa3;
    }

    .btn-gray {
      background-color: #555;
      color: #fff;
    }

    .btn-gray:hover {
      background-color: #444;
    }

    .arrow-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }

    .arrow-circle i {
      font-size: 14px;
    }

    .btn-orange .arrow-circle i {
      color: #ff9800;
    }

    .btn-blue .arrow-circle i {
      color: #3c8dbc;
    }

    .btn-gray .arrow-circle i {
      color: #aaa;
    }

    input[type="file"] {
      display: none;
    }

    #ocr-result {
      margin-top: 20px;
      padding: 10px;
      background: #f7f7f7;
      border-radius: 5px;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .footer {
      text-align: center;
      font-size: 14px;
      color: #666;
      padding: 15px 10px;
      background-color: #f4f4f4;
    }

    @media (max-width: 480px) {
      .logo-img {
        width: 50%;
      }

      .login-title {
        font-size: 20px;
      }

      .subtitle {
        font-size: 14px;
      }

      .btn {
        padding: 12px 15px;
        font-size: 14px;
      }

      .arrow-circle {
        width: 28px;
        height: 28px;
      }

      .arrow-circle i {
        font-size: 12px;
      }

      .footer {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/img/1000012077.jpg" alt="Dynamsoft Logo" class="logo-img">

    <div class="login-title">Login</div>
    <div class="subtitle">Scan Insurance Card</div>

    <input type="file" id="videoInput" accept="video/*">
    <input type="file" id="imageInput" accept="image/*">

    <button class="btn btn-orange scan-with-camera">
      <span><i class="fas fa-camera"></i> With Live Camera</span>
      <span class="arrow-circle"><i class="fas fa-arrow-right"></i></span>
    </button>

    <button class="btn btn-orange" id="scan-two-sides-btn">
      <span><i class="fas fa-camera"></i> Tap to Scan Card (Both Sides)</span>
      <span class="arrow-circle"><i class="fas fa-arrow-right"></i></span>
    </button>

    <button class="btn btn-blue scan-with-sample-image">
      <span><i class="fas fa-id-card"></i> Scan With Sample Videos</span>
      <span class="arrow-circle"><i class="fas fa-arrow-right"></i></span>
    </button>

    <button class="btn btn-gray scan-with-image-gallery">
      <span><i class="fas fa-image"></i> Scan from your image gallery</span>
      <span class="arrow-circle"><i class="fas fa-arrow-right"></i></span>
    </button>

    <input type="file" id="initialFile" accept="image/*" />

    <div id="ocr-result"></div>
  </div>

  <div class="footer">
    ©️ Copyright 2025 Master Momar Mbergan
  </div>

  <!-- JavaScript -->
  <script>
    const scanWithCameraButton = document.querySelector(".scan-with-camera");
    const scanWithSampleImgButton = document.querySelector(".scan-with-sample-image");
    const scanWithGalleryButton = document.querySelector(".scan-with-image-gallery");
    const fileInput = document.getElementById("initialFile");
    const ocrResultDiv = document.getElementById("ocr-result");
    const scanTwoSidesBtn = document.getElementById("scan-two-sides-btn");

    let result = null;
    let imageCache = {
      front: null,
      back: null
    };

    const mrzscanner = new Dynamsoft.MRZScanner({
      license: "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0MzI5ODU4LU1UQTBNekk1T0RVNExYZGxZaTFVY21saGJGQnliMm8iLCJtYWluU2VydmVyVVJMIjoiaHR0cHM6Ly9tZGxzLmR5bmFtc29mdG9ubGluZS5jb20iLCJvcmdhbml6YXRpb25JRCI6IjEwNDMyOTg1OCIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbSIsImNoZWNrQ29kZSI6MTczNDA3NjY3M30=",
      resultViewConfig: {
        toolbarButtonsConfig: {
          done: { label: "Return Home" }
        }
      },
      scannerViewConfig: {
        cameraEnhancerUIPath: "./dist/mrz-scanner.ui.html",
      },
      templateFilePath: "./dist/mrz-scanner.template.json"
    });

    // Scan with live camera
    scanWithCameraButton.addEventListener("click", async function () {
      try {
        result = await mrzscanner.launch();
        console.log("MRZ Result from camera:", result);
      } catch (error) {
        console.error("MRZ scan error:", error);
      }
    });

    // Scan with sample image
    scanWithSampleImgButton.addEventListener("click", async function () {
      try {
        result = await mrzscanner.launch(null, "virtual1");
        console.log("MRZ Result from sample:", result);
      } catch (error) {
        console.error("Sample scan error:", error);
      }
    });

    // Scan from gallery
    scanWithGalleryButton.addEventListener("click", function () {
      fileInput.click();
    });

    fileInput.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      try {
        // Launch MRZ scanner
        result = await mrzscanner.launch(file);
        console.log("MRZ Result from gallery image:", result);
        runTesseractOCR(file);
      } catch (err) {
        console.warn("MRZ scan failed, falling back to Tesseract OCR...");
        runTesseractOCR(file);
      }

      this.value = "";
    });

    // OCR fallback using Tesseract
    async function captureImage(label) {
      return new Promise((resolve, reject) => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.capture = "environment";

        input.onchange = () => {
          const file = input.files[0];
          if (file) {
            resolve(file);
          } else {
            reject(`${label} image capture canceled`);
          }
        };

        input.click();
      });
    }

 scanTwoSidesBtn.addEventListener("click", async () => {
      ocrResultDiv.innerText = "Launching MRZ Scanner for Front Side...";
      try {
        const frontResult = await mrzscanner.launch();
        const frontImage = await getImageDataURL(frontResult);

        if (!frontImage) {
          ocrResultDiv.innerText = "Failed to capture front image.";
          return;
        }

        imageCache.front = frontImage;
        ocrResultDiv.innerText = "Front image captured.\nLaunching MRZ Scanner for Back Side...";

        const backResult = await mrzscanner.launch();
        const backImage = await getImageDataURL(backResult);

        if (!backImage) {
          ocrResultDiv.innerText = "Failed to capture back image.";
          return;
        }

        imageCache.back = backImage;
        ocrResultDiv.innerText = "Both images captured. Running OCR...\n";

        await runTesseractOCR(imageCache.front, "Front");
        await runTesseractOCR(imageCache.back, "Back");
      } catch (error) {
        console.error("Error scanning both sides:", error);
        ocrResultDiv.innerText = "Error during scanning. Please try again.";
      }
    });

    async function getImageDataURL(result) {
  try {
    const canvas = await result.originalImageResult?.toCanvas();
    return canvas?.toDataURL() || null;
  } catch (e) {
    console.warn("Failed to extract image:", e);
    return null;
  }
}

function runTesseractOCR(input, label = "Image") {
  const processImage = (dataURL) => {
    Tesseract.recognize(dataURL, 'eng', {
      logger: m => console.log(`[${label}]`, m)
    }).then(({ data: { text } }) => {
      console.log(`[${label}] OCR Text:`, text);
      ocrResultDiv.innerText += `\n----- ${label.toUpperCase()} OCR Result -----\n${text.trim()}\n`;
    }).catch(err => {
      console.error(`[${label}] OCR error:`, err);
      ocrResultDiv.innerText += `\n[${label}] Failed to extract text.\n`;
    });
  };

  if (typeof input === "string") {
    // It's already a data URL
    processImage(input);
  } else if (input instanceof Blob) {
    const reader = new FileReader();
    reader.onload = () => processImage(reader.result);
    reader.readAsDataURL(input);
  } else {
    console.warn(`[${label}] Invalid input for OCR`);
    ocrResultDiv.innerText += `\n[${label}] Invalid input for OCR.\n`;
  }
}


  </script>
</body>
</html>
