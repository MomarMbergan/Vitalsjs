<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>EEG Dashboard — Main (Chart.js, 12 charts)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- Chart.js + FFT -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fft.js/dist/fft.min.js"></script>
<!-- RIPEMD-320 library: must be present locally as ripemd320.js -->
<script src="ripemd320.js"></script>

<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
  #topbar{position:fixed;left:12px;top:8px;z-index:60;display:flex;gap:8px;align-items:center}
  #gammaBtn{background:linear-gradient(90deg,#7b2cff,#ff7a00);color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer}
  #timer{font-family:monospace;color:#0f0}
  #status{position:fixed;right:12px;top:8px;text-align:right;font-family:monospace;z-index:60}
  #camera{position:fixed;left:0;top:0;width:100vw;height:100vh;object-fit:cover;z-index:0;opacity:0.06}
  #overlayCanvas{position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:1;pointer-events:none}
  #grid{position:relative;z-index:20;padding:90px 18px 140px 18px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .panel{background:rgba(255,255,255,0.02);border-radius:12px;padding:8px;min-height:260px;box-shadow:0 0 30px rgba(0,0,0,0.4)}
  .title{color:#fff;font-weight:700;font-size:13px;margin-bottom:6px}
  canvas.chart{width:100%;height:100%}
  .row2 .panel{background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .stopped *{color:#ff0000 !important}
</style>
</head>
<body>
  <!-- hidden video for camera -->
  <video id="video" autoplay muted playsinline style="display:none"></video>
  <canvas id="overlayCanvas"></canvas>

  <div id="topbar">
    <button id="gammaBtn">Γ Gamma</button>
    <input id="timerInput" value="00:30:00" style="width:120px;padding:6px;border-radius:6px;background:#111;color:#fff;border:0" />
    <button id="setBtn">Set</button>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <div id="timer" style="margin-left:12px">00:30:00</div>
  </div>

  <div id="status">
    <div id="clock">--:--:--</div>
    <div id="eegHz">EEG Hertz: --.- Hz</div>
    <div id="hr">Heart Rate: --.- BPM</div>
    <div id="spo2">SpO₂: --.- %</div>
    <div id="sound">Sound: --.- dB</div>
    <div id="hash">EEG Process: --</div>
  </div>

  <!-- 12 chart panels (4x3 layout made as four columns then two rows with the duplicates) -->
  <div id="grid">
    <!-- Row 1: Phys neon -->
    <div class="panel"><div class="title">EEG Hz (Neon)</div><canvas id="chart_eeg_1" class="chart"></canvas></div>
    <div class="panel"><div class="title">Heart BPM (Neon)</div><canvas id="chart_hr_1" class="chart"></canvas></div>
    <div class="panel"><div class="title">Sound dB (Neon)</div><canvas id="chart_sound_1" class="chart"></canvas></div>
    <div class="panel"><div class="title">SpO₂ % (Neon)</div><canvas id="chart_spo2_1" class="chart"></canvas></div>

    <!-- Row 2: Phys ironbow duplicates -->
    <div class="panel row2"><div class="title">EEG Hz (Iron)</div><canvas id="chart_eeg_2" class="chart"></canvas></div>
    <div class="panel row2"><div class="title">Heart BPM (Iron)</div><canvas id="chart_hr_2" class="chart"></canvas></div>
    <div class="panel row2"><div class="title">Sound dB (Iron)</div><canvas id="chart_sound_2" class="chart"></canvas></div>
    <div class="panel row2"><div class="title">SpO₂ % (Iron)</div><canvas id="chart_spo2_2" class="chart"></canvas></div>

    <!-- Row 3: Photometric metrics (4 panels) -->
    <div class="panel"><div class="title">Lumens (lm)</div><canvas id="chart_lumens" class="chart"></canvas></div>
    <div class="panel"><div class="title">Lux (lx)</div><canvas id="chart_lux" class="chart"></canvas></div>
    <div class="panel"><div class="title">Foot-candle</div><canvas id="chart_fc" class="chart"></canvas></div>
    <div class="panel"><div class="title">Candela / Nits / CRI</div><canvas id="chart_light_misc" class="chart"></canvas></div>
  </div>

<script>
/* ----------------------
  Config & globals
------------------------*/
const ironPalette = [
  'rgb(40,10,80)',   // delta
  'rgb(120,20,140)', // theta
  'rgb(255,80,10)',  // alpha
  'rgb(255,210,40)', // beta
  'rgb(255,255,240)' // gamma
];
const neonPalette = ['#0000FF','#00FF00','#FFFF00','#FFA500','#FF0000'];

const AR=0.2989, AG=0.5870, AB=0.1140;
const samplingRate=30, bufferLen=256;
let signalBuffer=[], peakTimes=[], combinedEEGHz=0, heartRate=0, soundDB=0;
let latestBands={}; let csvRows=[]; let stopped=false;

/* DOM */
const video = document.getElementById('video');
const overlayCanvas = document.getElementById('overlayCanvas');
const overlayCtx = overlayCanvas.getContext('2d');
const clockEl = document.getElementById('clock');
const eegEl = document.getElementById('eegHz');
const hrEl = document.getElementById('hr');
const spo2El = document.getElementById('spo2');
const soundEl = document.getElementById('sound');
const hashEl = document.getElementById('hash');

function resize() {
  overlayCanvas.width = window.innerWidth;
  overlayCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

/* Charts: Chart.js instances */
const charts = {};
function createLine(id, color){
  const ctx = document.getElementById(id).getContext('2d');
  // HD backing store
  document.getElementById(id).width = 1280; document.getElementById(id).height = 720;
  return new Chart(ctx, {
    type:'line',
    data:{labels:[], datasets:[{label:id, data:[], borderColor:color, backgroundColor: color.replace('rgb','rgba').replace(')',',0.06)'), pointRadius:0, tension:0.18}]},
    options:{responsive:true, animation:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}
  });
}

/* initialize all 12 charts */
function initCharts(){
  charts.eeg1 = createLine('chart_eeg_1', neonPalette[0]);
  charts.hr1 = createLine('chart_hr_1', neonPalette[1]);
  charts.sound1 = createLine('chart_sound_1', neonPalette[2]);
  charts.spo21 = createLine('chart_spo2_1', neonPalette[3]);

  charts.eeg2 = createLine('chart_eeg_2', ironPalette[4]);
  charts.hr2 = createLine('chart_hr_2', ironPalette[2]);
  charts.sound2 = createLine('chart_sound_2', ironPalette[3]);
  charts.spo22 = createLine('chart_spo2_2', ironPalette[1]);

  charts.lumens = createLine('chart_lumens', ironPalette[2]);
  charts.lux = createLine('chart_lux', ironPalette[3]);
  charts.fc = createLine('chart_fc', ironPalette[0]);
  charts.misc = createLine('chart_light_misc', ironPalette[4]);
}
initCharts();

/* append data helper */
function pushChart(chart, value){
  const t = new Date().toLocaleTimeString();
  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(Number(value.toFixed(1)));
  if (chart.data.labels.length > 120){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
  chart.update('none');
}

/* -----------------------
  Camera & audio
------------------------*/
let audioCtx=null, analyser=null, audioData=null;
async function startDevices(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:{ideal:1920}, height:{ideal:1080}}, audio:true});
    video.srcObject = stream;
    // audio
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    src.connect(analyser);
    audioData = new Float32Array(analyser.fftSize);
    audioLoop();
    frameLoop();
  } catch(e){ console.error(e); alert('Allow camera & mic'); }
}

function audioLoop(){
  if (!analyser) return;
  analyser.getFloatTimeDomainData(audioData);
  let sum=0; for (let i=0;i<audioData.length;i++) sum+=audioData[i]*audioData[i];
  const rms = Math.sqrt(sum/audioData.length) || 0;
  soundDB = rms > 0 ? (20*Math.log10(rms)+120) : 0;
  soundEl.textContent = `Sound: ${format00_0(soundDB)} dB`;
  if (!stopped) requestAnimationFrame(audioLoop);
}

function format00_0(v){ return Number(v||0).toFixed(1).padStart(4,'0'); }

/* frame loop: rPPG sampling + overlay minimal (low alpha overlay so main page is subtle) */
function frameLoop(){
  if (stopped) return;
  if (!video.videoWidth) { requestAnimationFrame(frameLoop); return; }
  // draw subtle overlay (very low alpha for main page)
  overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  overlayCtx.globalAlpha = 0.06;
  overlayCtx.drawImage(video, 0, 0, overlayCanvas.width, overlayCanvas.height);
  overlayCtx.globalAlpha = 1;

  // sample small center region for rPPG
  const w = Math.round(video.videoWidth * 0.15), h = Math.round(video.videoHeight * 0.15);
  const sx = Math.round((video.videoWidth-w)/2), sy = Math.round((video.videoHeight-h)/2);
  const tmp = document.createElement('canvas'); tmp.width = w; tmp.height = h;
  const tctx = tmp.getContext('2d'); tctx.drawImage(video, sx, sy, w, h, 0,0,w,h);
  const frame = tctx.getImageData(0,0,w,h).data;
  let r=0,g=0,b=0,cnt=0;
  for (let i=0;i<frame.length;i+=4){ r+=frame[i]; g+=frame[i+1]; b+=frame[i+2]; cnt++; }
  const avgR = r/cnt, avgG = g/cnt, avgB = b/cnt;
  const s = AR*avgR + AG*avgG + AB*avgB;
  signalBuffer.push(s);
  detectPeaks();
  if (signalBuffer.length >= bufferLen){
    const buff = signalBuffer.slice(-bufferLen);
    const bands = computeBands(buff);
    latestBands = bands;
    combineEEG(bands.dominantFreq || 0);
    csvRows.push([new Date().toISOString(), Number(combinedEEGHz).toFixed(1), Number(heartRate).toFixed(1), Number((95+Math.random()*3)).toFixed(1), Number(soundDB).toFixed(1)]);
    signalBuffer = signalBuffer.slice(Math.floor(bufferLen/2));
    // push to charts
    pushToAllCharts();
  }
  updateStatus();
  if (!stopped) requestAnimationFrame(frameLoop);
}

/* peak detection (simple) */
function detectPeaks(){
  if (signalBuffer.length < 6) return;
  const len = signalBuffer.length;
  const a=signalBuffer[len-6], b=signalBuffer[len-5], c=signalBuffer[len-4], d=signalBuffer[len-3], e=signalBuffer[len-2], f=signalBuffer[len-1];
  if (e > d && e > f && e > c) {
    const now = Date.now();
    if (peakTimes.length===0 || (now - peakTimes[peakTimes.length-1] > 300)) {
      peakTimes.push(now);
      const cutoff = now - 65000;
      peakTimes = peakTimes.filter(t=>t>=c
