async function captureDashboardPNG(customName=null){
  const target = document.getElementById('dashboardWrap');
  const canvas = await html2canvas(target, {
    useCORS: true,
    logging: false,
    scale: 1,
    scrollY: -window.scrollY,
    windowWidth: document.documentElement.scrollWidth,
    windowHeight: document.documentElement.scrollHeight
  });
  const link=document.createElement('a');
  const fname=customName || `dashboard_${new Date().toISOString().replace(/[:.]/g,'-')}.png`;
  link.download=fname;
  link.href=canvas.toDataURL('image/png');
  link.click();
}

function buildPayload(snapshotName, metrics, vision){
  const nowISO=new Date().toISOString(); const meta=deviceMeta; const cpuBytes=getCPUMemoryBytes(); const gpu=gpuInfo;
  const facesBlock = vision.entries.map(e => {
    const leftEye = e.eyes.left ? `(${e.eyes.left.x},${e.eyes.left.y})` : "none";
    const rightEye = e.eyes.right ? `(${e.eyes.right.x},${e.eyes.right.y})` : "none";
    const pixelsStr = `[${e.pixels.join(',')}]`;
    return `  - ${e.id}:
    - Center: (${e.center.x}, ${e.center.y})
    - Size: ${e.size}
    - Box: ${e.box.w} Ã— ${e.box.h}
    - Left Eye: ${leftEye}
    - Right Eye: ${rightEye}
    - Pixels: ${pixelsStr}`;
  }).join('\n');

  return `
Snapshot Filename: ${snapshotName}
Timestamp: ${nowISO}
Device IP Address: ${deviceIP}
Device Metadata:
- User Agent: ${meta.userAgent}
- Platform: ${meta.platform}
- Language: ${meta.language}
- Screen Resolution: ${meta.screenResolution}
- Color Depth: ${meta.colorDepth}
- Timezone: ${meta.timeZone}
Fusion Metrics:
- Frequency-Domain Fusion: ${metrics.freqFusion} Hz
- Peak-Based Fusion: ${metrics.peakFusion} Hz
- Cross-Spectral Coherence: ${metrics.coherence}
Vision Metrics:
- Face Count: ${vision.faces}
- Avg Confidence: ${vision.avgConfidence}
- Faces:
${facesBlock || '  - none'}
Browser Resource Metrics:
- CPU Memory Bytes: ${cpuBytes}
- GPU Memory Bytes: ${gpu.gpuMemoryBytes}
- GPU Vendor: ${gpu.gpuVendor}
- GPU Renderer: ${gpu.gpuRenderer}
`.trim();
}
