<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Real-Time rPPG-EEG Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- FFT -->
<script src="https://cdn.jsdelivr.net/npm/fft.js@0.3.0/dist/fft.min.js"></script>

<!-- CryptoJS core + RIPEMD-320 extension -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/ripemd320.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  font-family: Arial, sans-serif;
  background: black;
}

/* Camera video behind everything */
#cameraFeed {
  position: fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  object-fit: cover;
  z-index:0;
}

/* Charts float like AR HUD, 90% transparent */
.chartBox {
  backdrop-filter: blur(2px);
  background: rgba(0,0,0,0.1); /* 90% transparent */
  border-radius: 20px;
  padding: 6px;
  z-index: 20;
  box-shadow: 0 4px 12px rgba(0,0,0,0.35);
}

/* Layout: flexible grid overlay */
#chartsGrid {
  position: absolute;
  top:0; left:0;
  width:100%; height:100%;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-auto-rows: 33vh;
  gap: 8px;
  padding: 8px;
  z-index: 20;
}

.chartBox canvas {
  width: 100%;
  height: 100%;
}

/* Camera button */
#snapBtn {
  position: fixed;
  bottom: 20px;
  left: calc(50% - 35px);
  width: 70px; height: 70px;
  border-radius: 50%;
  background: red;
  border: 4px solid white;
  z-index: 50;
  cursor: pointer;
}

/* Flip camera */
#flipBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px; height: 60px;
  border-radius: 50%;
  background: white;
  color: black;
  text-align: center;
  line-height: 60px;
  font-size: 22px;
  z-index: 50;
  cursor: pointer;
}

/* FPS + CPU overlay */
#fpsCounter {
  position: fixed;
  top: 10px;
  right: 10px;
  font-family: monospace;
  font-size: 18px;
  color: lime;
  background: rgba(0,0,0,0.4);
  padding: 6px 10px;
  border-radius: 8px;
  z-index: 100;
}
</style>
</head>

<body>

<video id="cameraFeed" autoplay playsinline></video>

<button id="snapBtn" title="Capture"></button>
<button id="flipBtn" title="Flip">â‡†</button>

<div id="chartsGrid"></div>
<div id="fpsCounter">FPS: 0 | CPU: 0 ms</div>

<script>
/* ======================================================
   CAMERA SETUP
====================================================== */
let cameraFacing = "user";

async function startCamera() {
  const video = document.getElementById("cameraFeed");
  const constraints = {
    audio: false,
    video: {
      facingMode: cameraFacing,
      width: { ideal: 1920 },
      height: { ideal: 1080 }
    }
  };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
  } catch (err) {
    console.warn("Camera error:", err);
  }
}

document.getElementById("flipBtn").onclick = () => {
  cameraFacing = cameraFacing === "user" ? "environment" : "user";
  startCamera();
};

startCamera();

/* ======================================================
   CONSTANTS
====================================================== */
const SAMPLE_RATE = 256;
const BUFFER_SIZE = 256;

const fft = new FFT(BUFFER_SIZE);
const rppgBuffer = new Float32Array(BUFFER_SIZE);
const eegBuffer  = new Float32Array(BUFFER_SIZE);

/* Hann window */
const hann = new Float32Array(BUFFER_SIZE);
for (let i = 0; i < BUFFER_SIZE; i++) {
  hann[i] = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (BUFFER_SIZE - 1)));
}

/* Combined HE */
function computeCombinedHE(rppgAmp, eegAmp) {
  return Math.sqrt(rppgAmp * rppgAmp + eegAmp * eegAmp);
}

/* RIPEMD-320 Hash */
function hashFrame(dataArray) {
  const json = JSON.stringify(dataArray);
  return CryptoJS.RIPEMD320(json).toString();
}

/* EEG bands */
const eegBands = {
  Delta:  [0.5, 4],
  Theta:  [4, 8],
  Alpha:  [8, 12],
  Beta:   [12, 30],
  Gamma:  [30, 80]
};

/* ======================================================
   CHARTS
====================================================== */
const grid = document.getElementById("chartsGrid");
const charts = [];

function addChart(title) {
  const box = document.createElement("div");
  box.className = "chartBox";
  const c = document.createElement("canvas");
  box.appendChild(c);
  grid.appendChild(box);

  return new Chart(c, {
    type: "line",
    data: {
      labels: Array(60).fill(""),
      datasets: [{
        label: title,
        data: Array(60).fill(0),
        borderColor: "rgba(0,200,255,0.85)",
        backgroundColor: "rgba(0,200,255,0.12)",
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options:{
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales:{ x:{display:false}, y:{display:false} },
      plugins:{ legend:{display:false} }
    }
  });
}

const chartNames = [
  "Combined HE (Hz)", "Delta", "Theta", "Alpha", "Beta", "Gamma",
  "rPPG", "EEG Raw", "FFT Spectrum", "Heart Rate", "Breathing Rate", "Hash"
];
chartNames.forEach(n => charts.push(addChart(n)));

/* ======================================================
   FPS + CPU Monitor
====================================================== */
let lastFrameTime = performance.now();
let frameCount = 0;
let fps = 0;
let cpuTime = 0;

function updateFPS(startTime) {
  const now = performance.now();
  frameCount++;
  cpuTime = (now - startTime).toFixed(1);
  if (now - lastFrameTime >= 1000) {
    fps = frameCount;
    frameCount = 0;
    lastFrameTime = now;
  }
  document.getElementById("fpsCounter").textContent = `FPS: ${fps} | CPU: ${cpuTime} ms`;
}

/* ======================================================
   REAL-TIME LOOP (throttled)
====================================================== */
function updateCharts() {
  const startTime = performance.now();
  const t = performance.now();

  // Fake signals
  for (let i = 0; i < BUFFER_SIZE; i++) {
    eegBuffer[i]  = Math.sin(i * 0.1  + t / 300) * hann[i];
    rppgBuffer[i] = Math.sin(i * 0.03 + t / 400) * hann[i];
  }

  // FFT
  const input  = fft.createComplexArray();
  const output = fft.createComplexArray();
  for (let i = 0; i < BUFFER_SIZE; i++) {
    input[2*i] = eegBuffer[i];
    input[2*i+1] = 0;
  }
  fft.transform(output, input);

  const mags = new Float32Array(BUFFER_SIZE/2);
  for (let i = 0; i < BUFFER_SIZE/2; i++) {
    const real = output[2*i], imag = output[2*i+1];
    mags[i] = Math.sqrt(real*real + imag*imag);
  }

  // Combined HE
  const combined = computeCombinedHE(Math.abs(rppgBuffer[10]), Math.abs(eegBuffer[10]));
  charts[0].data.datasets[0].data.push(combined);

  // EEG bands
  let idx = 1;
  for (const [
