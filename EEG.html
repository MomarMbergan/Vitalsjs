  <!DOCTYPE html>
<html>
<head>
  <title>EEG + rPPG Dashboard (Fusion Methods)</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial;
      text-align: center;
      overflow: hidden;
      font-size: 18px; /* 3 sizes bigger */
    }

    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }

    canvas {
      width: 90%;
      height: 200px;
      background: rgba(0,0,0,0.05);
      margin-top: 10px;
      border-radius: 10px;
      z-index: 1;
      position: relative;
    }

    #foreheadBox {
      position: absolute;
      border: 2px solid red;
      pointer-events: none;
      z-index: 2;
    }

    #fusionOutput {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      color: white;
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 5px;
      z-index: 3;
      text-align: left;
    }

    #colorbarEEG, #colorbarRPPG {
      width: 90%;
      height: 20px;
      margin: 10px auto;
      border-radius: 5px;
      background: linear-gradient(to right, blue, cyan, yellow, red);
    }

    .controls {
      margin: 15px;
    }

    button, input[type=range] {
      margin: 5px;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>

<video id="camera" autoplay muted playsinline></video>
<div id="foreheadBox"></div>

<canvas id="rppgChart"></canvas>
<div id="colorbarRPPG"></div>

<canvas id="eegChart"></canvas>
<div id="colorbarEEG"></div>

<!-- Spectrum overlays -->
<canvas id="rppgFFT"></canvas>
<canvas id="eegFFT"></canvas>

<!-- Controls -->
<div class="controls">
  <button onclick="toggleThermal('rppg')">Toggle rPPG Thermal</button>
  <button onclick="toggleThermal('eeg')">Toggle EEG Thermal</button><br>
  <label>Smoothing</label><input type="range" id="smoothing" min="0" max="1" step="0.1" value="0.4">
  <label>FFT Window</label><input type="range" id="fftWindow" min="64" max="512" step="64" value="256">
  <label>Amplitude Scale</label><input type="range" id="ampScale" min="1" max="5" step="0.5" value="1">
</div>

<div id="fusionOutput">
  <div id="freqFusion">1. Frequency-Domain Fusion: 0 Hz</div>
  <div id="peakFusion">2. Peak-Based Fusion: 0 Hz</div>
  <div id="coherenceFusion">3. Cross-Spectral Coherence: 0</div>
  <div>
    $$F_{fusion}(f) = FFT_{rPPG}(f) + FFT_{EEG}(f)$$
  </div>
</div>

<script>
/* -------------------------------
   CAMERA FULL SCREEN + rPPG
-------------------------------- */
const video = document.getElementById('camera');
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }})
.then(stream => video.srcObject = stream);

let rData = [];
let eegData = [];

/* -------------------------------
   Iron Bow Colormap
-------------------------------- */
function ironbowColor(value, min, max) {
  const ratio = (value - min) / (max - min);
  const r = Math.min(255, Math.max(0, 255 * ratio));        
  const g = Math.min(255, Math.max(0, 255 * (1 - Math.abs(ratio - 0.5) * 2))); 
  const b = Math.min(255, Math.max(0, 255 * (1 - ratio)));  
  return `rgb(${r},${g},${b})`;
}

/* -------------------------------
   rPPG Heart Signal (Alluvial)
-------------------------------- */
const rppgCtx = document.getElementById('rppgChart').getContext('2d');
const rppgChart = new Chart(rppgCtx, {
  type: 'line',
  data: { labels: Array(300).fill(""), datasets: [{
    label: "rPPG Heart Signal",
    data: Array(300).fill(0),
    borderWidth: 2,
    pointRadius: 0,
    fill: true,
    segment: {
      borderColor: ctx => ironbowColor(ctx.p0.parsed.y, -20, 20),
      backgroundColor: ctx => ironbowColor(ctx.p0.parsed.y, -20, 20)
    }
  }]},
  options: { animation: false, elements: { line: { tension: 0.4 } },
    scales: { y: { min: -20, max: 20 } }, plugins: { legend: { display: false } } }
});

/* -------------------------------
   EEG Signal (Thermal Line)
-------------------------------- */
const eegCtx = document.getElementById('eegChart').getContext('2d');
const eegChart = new Chart(eegCtx, {
  type: 'line',
  data: { labels: Array(300).fill(""), datasets: [{
    label: "EEG Signal",
    data: Array(300).fill(0),
    borderWidth: 2,
    pointRadius: 0,
    segment: {
      borderColor: ctx => ironbowColor(ctx.p0.parsed.y, -100, 100)
    }
  }]},
  options: { animation: false, scales: { y: { min: -100, max: 100 } },
    plugins: { legend: { display: false } } }
});

/* -------------------------------
   Toggle Thermal Views
-------------------------------- */
function toggleThermal(signal) {
  if (signal === 'rppg') {
    const ds = rppgChart.data.datasets[0];
    if (ds.segment.borderColor) {
      ds.segment = { borderColor: "red", backgroundColor: "rgba(255,0,0,0.3)" };
    } else {
      ds.segment = {
        borderColor: ctx => ironbowColor(ctx.p0.parsed.y, -20, 20),
        backgroundColor: ctx => ironbowColor(ctx.p0.parsed.y, -20, 20)
      };
    }
    rppgChart.update();
  }
  if (signal === 'eeg') {
    const ds = eegChart.data.datasets[0];
    if (ds.segment.borderColor) {
      ds.segment = { borderColor: "cyan" };
    } else {
      ds.segment = {
        borderColor: ctx => ironbowColor(ctx.p0.parsed.y, -100, 100)
      };
    }
    eegChart.update();
  }
}

/* -------------------------------
   rPPG frame reader
-------------------------------- */
setInterval(() => {
  if (!video.videoWidth) return;
  const w = video.videoWidth, h = video.videoHeight;
  const foreheadW = w * 0.30, foreheadH = h * 0.10;
  const foreheadX = w * 0.35, foreheadY = h * 0.15;
  const box = document.getElementById("foreheadBox");
  const rect = video.getBoundingClientRect();
  const scaleX = rect.width / w, scaleY = rect.height / h;
  box.style.left = (rect.left + foreheadX * scaleX) + "px";
  box.style.top  = (rect.top + foreheadY * scaleY) + "px";
  box.style.width  = foreheadW * scaleX + "px";
  box.style.height = foreheadH * scaleY + "px";

  const temp = document.createElement("canvas");
