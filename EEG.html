<!DOCTYPE html>
<html>
<head>
  <title>SkyNet Biometric Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --bg:#000; --fg:#fff; --panel-bg:rgba(255,255,255,0.06); --accent:#39FF14;
      --panel-radius:10px;
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Arial,Helvetica,sans-serif;overflow:hidden}
    #dashboardContainer{position:relative;width:100vw;height:100vh;overflow:hidden}
    #camera,#overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
    #overlay{z-index:1;pointer-events:none}
    #statusBadge{
      position:absolute;top:12px;left:50%;transform:translateX(-50%);
      z-index:6;background:rgba(0,0,0,0.55);padding:8px 20px;border-radius:8px;
      font-weight:800;font-size:18px;text-shadow:0 0 6px rgba(255,255,255,0.4);
      transition:color 0.3s ease,text-shadow 0.3s ease;
    }
    #flipCameraBtn{
      position:absolute;top:12px;right:12px;z-index:6;
      background:rgba(0,0,0,0.55);color:#fff;padding:8px 12px;border-radius:8px;
      cursor:pointer;font-weight:700;border:1px solid rgba(255,255,255,0.22)
    }
    #dashboardWrap{position:absolute;z-index:2;width:100%;height:calc(100vh - 110px);margin-top:64px;overflow-y:auto}
    .dashboard{display:grid;grid-template-columns:1fr;gap:10px;width:95%;max-width:1300px;margin:0 auto}
    .panel{background:var(--panel-bg);border-radius:var(--panel-radius);padding:10px;backdrop-filter:blur(2px)}
    .panel h3{margin:0 0 8px;font-weight:700;font-size:22px}
    canvas.chart{width:100%;height:240px;background:rgba(0,0,0,0.05);border-radius:var(--panel-radius)}
    .colorbar{width:100%;height:22px;margin-top:8px;border-radius:5px;
      background:linear-gradient(90deg,#2a004b,#8b0000,#ff6a00,#ffff00)}
    #fusionEq{margin-top:8px;text-align:center;font-size:20px}
    .footer{position:absolute;bottom:0;left:0;right:0;z-index:3;background:rgba(0,0,0,0.35);padding:10px 12px;
      display:grid;grid-template-columns:1fr auto;gap:8px;backdrop-filter:blur(4px)}
    .footer .sliders{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .slider-wrap{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
    #countdown{font-size:14px;color:#9cf;opacity:0.95}
    #togglePanel{position:absolute;top:50%;right:12px;transform:translateY(-50%);
      z-index:6;display:flex;flex-direction:column;gap:10px}
    .icon-btn{background:rgba(0,0,0,0.55);color:#fff;border-radius:8px;padding:8px;cursor:pointer;font-size:20px}
    .sankey-link{fill:none;stroke-opacity:0.9}
    .sankey-node rect{fill-opacity:0.95}
    .sankey-label{font-size:12px;pointer-events:none;text-shadow:0 0 6px rgba(255,255,255,0.4)}
    @media(min-width:768px){.dashboard{grid-template-columns:1fr 1fr}}
    @media(min-width:1200px){.dashboard{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>
<body>
<div id="dashboardContainer">
  <video id="camera" autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="statusBadge">Analyzing</div>
  <button id="flipCameraBtn">Flip Camera</button>

  <div id="dashboardWrap">
    <div class="dashboard">
      <div class="panel"><h3>Alluvial flow</h3><svg id="alluvial" width="100%" height="220"></svg></div>
      <div class="panel"><h3>Heart Rate</h3><canvas id="rppgChart" class="chart"></canvas><div class="colorbar"></div></div>
      <div class="panel"><h3>EEG</h3><canvas id="eegChart" class="chart"></canvas><div class="colorbar"></div></div>
      <div class="panel"><h3>Fusion</h3>
        <div id="fusionOutput">
          <div id="freqFusion">1. Frequency-Domain Fusion: 0 Hz</div>
          <div id="peakFusion">2. Peak-Based Fusion: 0 Hz</div>
          <div id="coherenceFusion">3. Cross-Spectral Coherence: 0</div>
        </div>
        <div id="fusionEq">$$F_{fusion}(f)=FFT_{EEG}+FFT_{rPPG}+FFT_{HR}$$</div>
      </div>
    </div>
  </div>

  <div id="togglePanel">
    <button class="icon-btn" id="btnThermal">üå°Ô∏è</button>
    <button class="icon-btn" id="btnEEG">üß†</button>
    <button class="icon-btn" id="btnAnnotations">‚ú≥Ô∏è</button>
    <button class="icon-btn" id="btnSpectra">üìà</button>
    <button class="icon-btn" id="btnSnapshot">üì∏</button>
  </div>

  <div class="footer">
    <div class="sliders">
      <div class="slider-wrap"><div class="label">üéöÔ∏è</div><input type="range" id="smoothing" min="0" max="1" step="0.1" value="0.5"></div>
      <div class="slider-wrap"><div class="label">ü™Ñ</div><input type="range" id="fftWindow" min="128" max="1024" step="128" value="512"></div>
      <div class="slider-wrap"><div class="label">üîä</div><input type="range" id="ampScale" min="0.2" max="5" step="0.1" value="1"></div>
    </div>
    <div id="countdown">Next auto-save: 60s</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script>
let facingMode="user";const video=document.getElementById('camera');let mediaStream=null;
async function startCamera(){
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    video.srcObject=mediaStream;await video.play();
  }catch(e){console.error("Camera init error:",e);}
}
startCamera();
document.getElementById('flipCameraBtn').addEventListener('click',async()=>{
  facingMode=(facingMode==="user")?"environment":"user";
  await startCamera();
});

// Iron-bow continuous color
function ironBowColor(value,min,max){
  const t=Math.max(0,Math.min(1,(value-min)/(max-min)));
  return d3.interpolateInferno(t);
}

// Charts
const rppgCtx=document.getElementById('rppgChart').getContext('2d');
const rppgChart=new Chart(rppgCtx,{type:'line',data:{labels:Array(300).fill(''),datasets:[{label:'HR',data:Array(300).fill(0),borderWidth:2,pointRadius:0,fill:true,
segment:{borderColor:ctx=>ironBowColor(ctx.p0.parsed.y,-40,40)}}]},options:{animation:false,scales:{y:{min:-40,max:40
