<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transparent rPPG-EEG Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- FFT -->
<script src="https://cdn.jsdelivr.net/npm/fft.js@0.3.0/dist/fft.min.js"></script>

<!-- CryptoJS core + RIPEMD-320 extension -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/ripemd320.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  font-family: Arial, sans-serif;
  background: black;
}

/* Camera video behind everything */
#cameraFeed {
  position: fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  object-fit: cover;
  z-index:0;
}

/* Charts float like AR HUD, faint frame only */
.chartBox {
  backdrop-filter: blur(2px);
  background: rgba(0,0,0,0.1); /* 90% transparent */
  border-radius: 20px;
  padding: 6px;
  z-index: 20;
}

/* Layout: flexible grid overlay */
#chartsGrid {
  position: absolute;
  top:0; left:0;
  width:100%; height:100%;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-auto-rows: 33vh;
  gap: 8px;
  padding: 8px;
  z-index: 20;
}

.chartBox canvas {
  width: 100%;
  height: 100%;
  background: transparent !important; /* ensure canvas is transparent */
}

/* Camera button */
#snapBtn {
  position: fixed;
  bottom: 20px;
  left: calc(50% - 35px);
  width: 70px; height: 70px;
  border-radius: 50%;
  background: red;
  border: 4px solid white;
  z-index: 50;
}

/* Flip camera */
#flipBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px; height: 60px;
  border-radius: 50%;
  background: white;
  color: black;
  text-align: center;
  line-height: 60px;
  font-size: 22px;
  z-index: 50;
}
</style>
</head>

<body>

<video id="cameraFeed" autoplay playsinline></video>

<button id="snapBtn"></button>
<button id="flipBtn">â‡†</button>

<div id="chartsGrid"></div>

<script>
/* ======================================================
   CAMERA SETUP
====================================================== */
let cameraFacing = "user";
async function startCamera() {
  const video = document.getElementById("cameraFeed");
  const constraints = {
    audio:false,
    video:{ facingMode: cameraFacing }
  };
  try {
    video.srcObject = await navigator.mediaDevices.getUserMedia(constraints);
  } catch(e){ console.error(e); }
}
document.getElementById("flipBtn").onclick = () => {
  cameraFacing = cameraFacing === "user" ? "environment" : "user";
  startCamera();
};
startCamera();

/* ======================================================
   CONSTANTS
====================================================== */
const SAMPLE_RATE = 256;
const BUFFER_SIZE = 256;
const fft = new FFT(BUFFER_SIZE);
const rppgBuffer = new Float32Array(BUFFER_SIZE);
const eegBuffer  = new Float32Array(BUFFER_SIZE);

/* EEG bands */
const eegBands = {
  Delta:[0.5,4], Theta:[4,8], Alpha:[8,12], Beta:[12,30], Gamma:[30,80]
};

/* Hash */
function hashFrame(arr){ return CryptoJS.RIPEMD320(JSON.stringify(arr)).toString(); }

/* ======================================================
   CHARTS
====================================================== */
const grid = document.getElementById("chartsGrid");
const charts = [];
function addChart(title){
  const box = document.createElement("div");
  box.className="chartBox";
  const c = document.createElement("canvas");
  box.appendChild(c);
  grid.appendChild(box);
  return new Chart(c,{
    type:"line",
    data:{ labels:Array(60).fill(""), datasets:[{
      label:title,
      data:Array(60).fill(0),
      borderColor:"rgba(0,200,255,0.9)",
      backgroundColor:"transparent",
      borderWidth:2,
      pointRadius:0,
      tension:0.25
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      scales:{x:{display:false},y:{display:false}},
      plugins:{legend:{display:false}}
    }
  });
}
["Combined HE","Delta","Theta","Alpha","Beta","Gamma",
 "rPPG","EEG Raw","FFT Spectrum","Heart Rate","Breathing Rate","Hash"]
.forEach(n=>charts.push(addChart(n)));

/* ======================================================
   LOOP
====================================================== */
function updateCharts(){
  const t=performance.now();
  for(let i=0;i<BUFFER_SIZE;i++){
    eegBuffer[i]=Math.sin(i*0.1+t/300);
    rppgBuffer[i]=Math.sin(i*0.03+t/400);
  }
  const input=fft.createComplexArray(), output=fft.createComplexArray();
  for(let i=0;i<BUFFER_SIZE;i++){ input[2*i]=eegBuffer[i]; input[2*i+1]=0; }
  fft.transform(output,input);
  const mags=[];
  for(let i=0;i<BUFFER_SIZE/2;i++){
    const re=output[2*i], im=output[2*i+1];
    mags[i]=Math.sqrt(re*re+im*im);
  }
  charts[0].data.datasets[0].data.push(Math.sqrt(rppgBuffer[10]**2+eegBuffer[10]**2));
  let idx=1;
  for(const [lo,hi] of Object.values(eegBands)){
    const loBin=Math.floor(lo*(BUFFER_SIZE/SAMPLE_RATE));
    const hiBin=Math.floor(hi*(BUFFER_SIZE/SAMPLE_RATE));
    const avg=mags.slice(loBin,hiBin).reduce((a,b)=>a+b,0)/(hiBin-loBin);
    charts[idx++].data.datasets[0].data.push(avg);
  }
  charts[6].data.datasets[0].data.push(rppgBuffer[128]);
  charts[7].data.datasets[0].data.push(eegBuffer[128]);
  charts[8].data.datasets[0].data=mags.slice(0,60);
  charts[9].data.datasets[0].data.push(60+40*Math.abs(rppgBuffer[100]));
  charts[10].data.datasets[0].data.push(14+6*Math.abs(rppgBuffer[20]));
  charts[11].data.datasets[0].data.push(hashFrame(mags).length%30);
  charts.forEach(ch=>{
    const d=ch.data.datasets[0].data;
    while(d.length>60) d.shift();
    ch.update('none');
  });
}
setInterval(updateCharts,40);
</script>
</body>
</html>
